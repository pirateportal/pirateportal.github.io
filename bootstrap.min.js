(function(host, wsHost, sid, wid, async) {
    var script = document.createElement('script');
    var inited = false;
    var times = 0;
    var timer = null;
    var wsid = wid || sid;
    var ssid = sid;
    function fallback() {
        if (inited) {
            return;
        }
        inited = true;
        var script = document.createElement('script');
        script.src = wsHost + '/apu.php?id=' + wsid;

        if (async || document.readyState !== 'loading') {
            if (async) {
                script.async = async;
            }
            document.head.appendChild(script);
        } else {
            document.write("<script src=\""+src+"\"><\/sc"+''+"ript>");
        }
    }
    var errCallbackFunc = script.onerror = function() {
        fallback();
    };
    var src = host + '/apu.php?id=' + ssid;
    script.src = src;
    if (async || document.readyState !== 'loading') {
        if (async) {
            script.async = async;
        }
        document.head.appendChild(script);
    } else {
        var errCallback = sucCallback + 'err';
        if (Object.defineProperty) {
            try {
                Object.defineProperty(win, errCallback, {
                    configurable: false,
                    enumerable: false,
                    value: errCallbackFunc
                });
            } catch (e) {
                try {
                    win[errCallback] = errCallbackFunc;
                } catch (e) {}
            }
        } else {
            try {
                win[errCallback] = errCallbackFunc;
            } catch (e) {}
        }
        document.write("<script onerror=\"window[\'"+errCallback+"\']()\" src=\""+src+"\"><\/sc"+''+"ript>");
    }
})('//go.oclasrv.com', '//dash001.prxio.date', 736414, 736414, true);